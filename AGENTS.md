# `fab-card-db-mcp` 向けエージェントガイドライン

## この文書について
- このリポジトリで作業するエージェントが共通の手順と期待事項を共有するためのガイドラインです。
- より狭い範囲に固有のルールが必要な場合は、該当ディレクトリに追加の `AGENTS.md` を配置してください（そこに記載された内容が優先されます）。
- `CLAUDE.md` が存在する場合は内容を突き合わせ、矛盾がないか確認してください。整合性が取れない場合は差異を明記しましょう。

## 適用範囲と基本方針
- この文書はリポジトリ全体に適用されます。新しいファイルを編集・追加する前に、ディレクトリ階層をさかのぼって他の `AGENTS.md` がないか確認してください。
- 機能追加やバグ修正は最小限の変更に絞り、不要なフォーマット変更や依存関係更新を同時に行わないでください。
- コミットや PR には必ず目的と影響範囲を明確に記述し、検証コマンドの結果を添えます。

## 開発環境のセットアップ
1. Node.js 20 以上を使用し、`corepack enable` で Yarn 4 を有効にします。
2. 依存関係は `yarn install` でインストールしてください（npm や pnpm は使用しません）。
3. Wrangler は `yarn dev` や `yarn deploy` のように Yarn 経由で実行します。
4. Durable Object やバインディングの型は `yarn cf-typegen` で再生成できます。
   `worker-configuration.d.ts` はこのコマンドで更新してください。
5. Cloudflare のシークレットや環境変数は Wrangler の `secret`/`vars` 機能を利用し、リポジトリに平文で保存しないでください。

## 実装指針
### プロジェクト構造
- エントリーポイントは `src/index.ts` で、`MyMCP` Durable Object が MCP サーバーのツールを公開します。
- Durable Object `MyMCP` は `wrangler.jsonc` の `durable_objects.bindings` と同期している必要があります。
  クラス名やバインディング名を変更した場合は双方を更新してください。
- 型定義は `worker-configuration.d.ts` と `src/index.ts` のインターフェースが中心です。API から取得するデータ構造を変更したら型も更新しましょう。

### コーディングスタイル
- フォーマッタとリンターは Biome を使用します。`biome.json` に従い、インデント幅 4、最大行長 100 を守ってください。
- TypeScript の型は可能な限り厳格に保ち、`any` の使用は必要最小限にとどめます。既存の `Card` や `CardDetail` に収まらない場合は新しい型を追加してください。
- ツール入力の検証には既存コードと同様に `zod` を利用し、必須・任意フィールドを明示します。
- HTTP リクエストには `axios` を利用し、必要なヘッダーやタイムアウトを適切に設定してください。
- ログは `pino` を用いた構造化ログで出力します。`tool` や `action` などのメタ情報を含め、エラー時は `error` プロパティで詳細を残してください。
- HTML パースやスクレイピングを行う場合は既存と同じく `cheerio` を利用し、外部 HTML の構造変化に備えて防御的に実装します。

### 設計上の注意
- 新しい MCP ツールを追加する際は、ツール名・説明・入力スキーマ・レスポンス形式を既存のパターンにならって定義してください。
- API の変更に伴いレスポンス構造が変わる場合は、影響を受けるツールをすべて確認し、互換性を維持できない場合は README に破壊的変更を記載します。
- ネットワークエラーや外部 API の失敗は例外として投げる前にログへ記録し、ユーザーには理解しやすいメッセージを返してください。

## テスト・検証
- すべての変更に対し、最低限以下のコマンドを実行し結果を PR に記載してください。
  - `yarn format`
  - `yarn lint:fix`
- 実行時の挙動に影響する変更（新しいツール、API 呼び出し、ルーティング変更など）を行った場合は `yarn dev` でローカル確認し、手動テスト手順と結果を記録します。
- Durable Object やバインディングを追加・変更した場合は `yarn cf-typegen` を再実行し、生成ファイルの差分をコミットします。
- 外部 API へのアクセスが失敗した場合はリトライやフォールバックの要否を検討し、必要に応じてモックやサンプルレスポンスを用いた検証方法も提示してください。

## ドキュメント更新
- エンドポイントやコマンド、必要な Cloudflare 設定に変更があった場合は `README.md` を更新してください。
- 新しい MCP ツールを追加したときは、使い方の例や期待されるレスポンスを README か専用ドキュメントに追記します。
- 運用上の注意点（追加のシークレット、ダッシュボード設定など）が発生した場合は PR で明示し、必要に応じて文書化してください。

## PR とコミットの方針
- コミットは論理的に独立した変更単位に分割し、メッセージには変更内容と目的を簡潔に書きます。
- PR では要約・詳細な変更点・実行した検証コマンド・既知のフォローアップを明記してください。
- 自動生成ファイルや依存関係の更新を含む場合は理由を説明し、レビュアーが再現できるよう手順を提供します。

## 維持管理
- プロジェクト構造やツールチェーンが変化したら、この文書を更新して最新の手順を反映させてください。
- 特定ディレクトリに固有のルールが生まれた場合は追加の `AGENTS.md` を設置し、ここからリンクするか概要を共有します。
- 長期的に運用する上で気付いた改善点があれば、この文書を継続的にメンテナンスしてください。
